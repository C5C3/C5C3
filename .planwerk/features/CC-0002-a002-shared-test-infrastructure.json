{
  "feature_id": "CC-0002",
  "title": "A002: Shared Test Infrastructure",
  "slug": "a002-shared-test-infrastructure",
  "status": "proposed",
  "phase": null,
  "summary": "",
  "description": "**Size:** ðŸ—ï¸ large\n**Category:** infrastructure\n**Priority:** high\n\n## Summary\n\nImplement the shared test infrastructure in `internal/common/testutil/` that all operator integration and E2E tests will depend on. This includes: an envtest bootstrap function starting a local API server + etcd with project and external CRDs; minimal fake CRD YAML schemas for five external operators (MariaDB, ESO, cert-manager, Memcached, RabbitMQ); a `SecretBuilder` establishing the fluent builder pattern; external operator simulators that patch CR status to mimic readiness; custom gomega assertion helpers for condition checking and resource existence; and a Chainsaw E2E directory structure with global configuration targeting Chainsaw v0.3+.\n\n## Scope\n\n**Included:**\n- `internal/common/testutil/envtest/` â€” `SetupEnvTest()` function: starts `envtest.Environment`, installs CRDs from `config/crd/bases` (own) and `fake_crds/` (external), registers schemes, returns `*rest.Config` + `client.Client` + teardown func. Follows the pattern from `docs/09-implementation/06-testing.md:90-104`\n- `internal/common/testutil/fake_crds/` â€” Minimal CRD YAML schemas (only fields operators interact with: `.status.conditions`, `.status.ready`, referenced `.spec` fields) for: MariaDB Operator (`MariaDB`, `Database`, `User`, `Grant`), ESO (`ExternalSecret`, `PushSecret`, `ClusterSecretStore`), cert-manager (`Certificate`, `ClusterIssuer`), Memcached Operator (`Memcached`), RabbitMQ Cluster Operator (`RabbitmqCluster`)\n- `internal/common/testutil/builders/` â€” `SecretBuilder` with chainable `WithName()`, `WithNamespace()`, `WithData()`, `WithStringData()`, `WithLabels()`, `WithOwnerRef()`, `Build()`, `Create(ctx, client)`. Establishes the fluent builder pattern that operator-specific builders (S011/S019) will follow\n- `internal/common/testutil/simulators/` â€” `SimulateMariaDBReady(ctx, client, name, namespace)`, `SimulateMemcachedReady(...)`, `SimulateExternalSecretSync(...)`, `SimulateJobComplete(...)` â€” each creates the CR if absent, then patches its status to indicate readiness\n- `internal/common/testutil/assertions/` â€” `AssertCondition(g, conditions, condType, status)`, `EventuallyCondition(ctx, client, obj, condType, status, timeout)`, `AssertResourceExists(ctx, client, key, obj)`, `AssertResourceNotExists(ctx, client, key, obj)`\n- `tests/e2e/chainsaw-config.yaml` â€” Global Chainsaw v0.3+ configuration (`apiVersion: chainsaw.kyverno.io/v1alpha1`, default timeouts, cleanup, parallel, JUnit output)\n- `tests/e2e/{keystone,c5c3,infrastructure}/.gitkeep` â€” Directory placeholders\n- Unit tests for assertions and builders; integration test verifying `SetupEnvTest()` starts/stops cleanly\n\n**Excluded (with rationale):**\n- `KeystoneBuilder`, `ControlPlaneBuilder` â€” API types don't exist until S011/S019; builder pattern established via `SecretBuilder` (YAGNI)\n- Actual Chainsaw test scenarios â€” S012, S016, S022; only directory structure and config here\n- CI pipeline integration â€” S003\n- Makefile `test-integration` / `install-test-deps` targets â€” S001 stubs, S003 implements\n- Controller-runtime reconciler test wiring â€” S014, reconciler-specific\n- OpenBao/ESO test doubles beyond `SimulateExternalSecretSync` â€” S010\n\n## Visualization\n\n```mermaid\nflowchart TD\n    subgraph testutil[\"internal/common/testutil/\"]\n        envtest_pkg[\"envtest/\\nSetupEnvTest()\"]\n        builders[\"builders/\\nSecretBuilder\"]\n        simulators[\"simulators/\\nSimulateMariaDBReady\\nSimulateMemcachedReady\\nSimulateExternalSecretSync\\nSimulateJobComplete\"]\n        assertions[\"assertions/\\nAssertCondition\\nEventuallyCondition\\nAssertResourceExists\\nAssertResourceNotExists\"]\n        fake_crds[\"fake_crds/\\nmariadb/ eso/ cert-manager/\\nmemcached/ rabbitmq/\"]\n    end\n\n    subgraph consumers[\"Future Consumers\"]\n        s012[\"S012: Keystone CRD Tests\"]\n        s014[\"S014: Keystone Reconciler Tests\"]\n        s022[\"S022: c5c3-operator Tests\"]\n    end\n\n    subgraph e2e[\"tests/e2e/\"]\n        chainsaw_cfg[\"chainsaw-config.yaml\"]\n        ks_dir[\"keystone/\"]\n        c5c3_dir[\"c5c3/\"]\n        infra_dir[\"infrastructure/\"]\n    end\n\n    envtest_pkg -->|\"loads\"| fake_crds\n    s012 -->|\"imports\"| envtest_pkg\n    s012 -->|\"imports\"| assertions\n    s014 -->|\"imports\"| envtest_pkg\n    s014 -->|\"imports\"| builders\n    s014 -->|\"imports\"| simulators\n    s014 -->|\"imports\"| assertions\n    s022 -->|\"imports\"| envtest_pkg\n    s022 -->|\"imports\"| simulators\n```\n\n```mermaid\nsequenceDiagram\n    participant T as Test Suite\n    participant E as SetupEnvTest\n    participant API as envtest API Server\n    participant etcd as etcd\n\n    T->>E: SetupEnvTest(crdPaths...)\n    E->>etcd: Start etcd process\n    E->>API: Start API server\n    E->>API: Install own CRDs from config/crd/bases\n    E->>API: Install fake external CRDs\n    E->>E: Register schemes\n    E-->>T: config, client, teardownFn\n\n    Note over T: Run tests using client...\n\n    T->>T: teardownFn()\n    T->>API: Stop API server\n    T->>etcd: Stop etcd\n```\n\n## Key Components\n\n- **`testutil/envtest/setup.go`** â€” `SetupEnvTest(crdPaths ...string) (*rest.Config, client.Client, func())`: boots envtest with API server + etcd, installs CRDs from provided paths plus `fake_crds/`, registers all relevant schemes (core, apps, batch + external operator types), returns config + client + teardown closure\n- **`testutil/fake_crds/{mariadb,eso,cert-manager,memcached,rabbitmq}/`** â€” Minimal CRD YAMLs defining only the spec/status fields operators interact with. Derived from `internal/common/database/`, `secrets/`, `tls/` function signatures in `docs/09-implementation/02-shared-library.md`\n- **`testutil/builders/secret.go`** â€” Fluent `SecretBuilder` returning `*corev1.Secret`. Pattern reference for operator-specific builders added in S011/S019\n- **`testutil/simulators/{mariadb,memcached,externalsecret,job}.go`** â€” Create external CRs with ready status to simulate third-party operator behavior in envtest. Each creates the CR if absent, patches `.status.ready = true` and condition `Ready=True`\n- **`testutil/assertions/conditions.go`** â€” Typed gomega helpers: `EventuallyCondition` polls via `Eventually()` + `client.Get()` until condition reaches expected status\n- **`testutil/assertions/resources.go`** â€” `AssertResourceExists` / `AssertResourceNotExists` for existence checks\n- **`tests/e2e/chainsaw-config.yaml`** â€” Global Chainsaw v0.3+ config: 120s assert timeout, 30s apply timeout, cleanup enabled, parallel execution, JUnit report output\n- **`tests/e2e/{keystone,c5c3,infrastructure}/.gitkeep`** â€” Empty directory structure for future test scenarios",
  "stories": [],
  "requirements": [],
  "tasks": [],
  "test_specifications": [],
  "affected_files": [],
  "similar_patterns": [],
  "review_criteria": [],
  "implementation_notes": "",
  "status_history": {
    "draft": {
      "github_account": "berendt",
      "timestamp": "2026-02-22T20:42:36.261902"
    },
    "elaborated": {
      "github_account": "berendt",
      "timestamp": "2026-02-22T20:58:38.083613"
    }
  },
  "origin": "plan",
  "devils_advocate_report": {
    "verdict": "RECONSIDER",
    "summary": "Failed to parse challenge report: no XML found in output",
    "challenges": [],
    "risk_flags": [],
    "alternatives": []
  }
}
